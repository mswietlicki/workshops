{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "servicePlan": {
            "type": "string"
        },
        "servicePlanGroup": {
            "type": "string"
        },
        "serviceBus": {
            "type": "string"
        },
        "webApi": {
            "type": "string"
        },
        "ASPNETCORE_ENVIRONMENT": {
            "type": "string"
        },
        "SERVICEBUS_SUBSCRIPTION_NAME": {
            "type": "string"
        },
        "MONGODB_CONNECTION_STRING": {
            "type": "string"
        },
        "MONGODB_DATABASE_NAME": {
            "type": "string"
        },
        "PYRA_SERVICEURL_USERINFO": {
            "type": "string"
        },
        "PYRA_S2SAPIKEY_USERINFO": {
            "type": "string"
        }
    },
    "variables": {},
    "resources": [{
            "type": "Microsoft.ServiceBus/namespaces",
            "sku": {
                "name": "Standard",
                "tier": "Standard"
            },
            "kind": "Messaging",
            "name": "[parameters('serviceBus')]",
            "apiVersion": "2015-08-01",
            "location": "West Europe",
            "tags": {},
            "properties": {
                "provisioningState": "Succeeded",
                "status": "Active",
                "createdAt": "2016-10-18T11:35:50.727Z",
                "serviceBusEndpoint": "[concat('https://', parameters('serviceBus'),'.servicebus.windows.net:443/')]",
                "enabled": true,
                "updatedAt": "2016-10-18T11:36:15.89Z"
            },
            "resources": [],
            "dependsOn": []
        },
        {
            "type": "Microsoft.ServiceBus/namespaces/AuthorizationRules",
            "name": "[concat(parameters('serviceBus'),'/RootManageSharedAccessKey')]",
            "apiVersion": "2015-08-01",
            "properties": {
                "rights": [
                    "Listen",
                    "Manage",
                    "Send"
                ]
            },
            "resources": [],
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBus'))]"
            ]
        },
        {
            "comments": "",
            "type": "Microsoft.Web/sites",
            "name": "[parameters('webApi')]",
            "apiVersion": "2015-08-01",
            "location": "[resourceGroup().location]",
            "tags": {},
            "properties": {
                "name": "[parameters('webApi')]",
                "hostNames": [
                    "[concat(parameters('webApi'),'.azurewebsites.net')]"
                ],
                "enabledHostNames": [
                    "[concat(parameters('webApi'),'.azurewebsites.net')]",
                    "[concat(parameters('webApi'),'.scm.azurewebsites.net')]"
                ],
                "serverFarmId": "[resourceId(parameters('servicePlanGroup'),'Microsoft.Web/serverfarms',parameters('servicePlan'))]",
                "siteConfig": {
                    "phpVersion": "off",
                    "alwaysOn": "true",
                    "webSocketsEnabled": "true",
                    "appSettings": [{
                            "name": "ASPNETCORE_ENVIRONMENT",
                            "value": "[parameters('ASPNETCORE_ENVIRONMENT')]"
                        },
                        {
                            "name": "SERVICEBUS_SUBSCRIPTION_NAME",
                            "value": "[parameters('SERVICEBUS_SUBSCRIPTION_NAME')]"
                        },
                        {
                            "name": "MONGODB_CONNECTION_STRING",
                            "value": "[parameters('MONGODB_CONNECTION_STRING')]"
                        },
                        {
                            "name": "MONGODB_DATABASE_NAME",
                            "value": "[parameters('MONGODB_DATABASE_NAME')]"
                        },
                        {
                            "name": "PYRA_SERVICEURL_USERINFO",
                            "value": "[parameters('PYRA_SERVICEURL_USERINFO')]"
                        },
                        {
                            "name": "PYRA_S2SAPIKEY_USERINFO",
                            "value": "[parameters('PYRA_S2SAPIKEY_USERINFO')]"
                        }
                    ],
                    "connectionStrings": [{
                        "name": "SERVICEBUS_CONNECTION_STRING",
                        "connectionString": "[listKeys(resourceId(concat('Microsoft.ServiceBus/namespaces/AuthorizationRules'),parameters('serviceBus'),'RootManageSharedAccessKey'),'2015-08-01').primaryConnectionString]",
                        "type": 3
                    }]
                }
            },
            "resources": [{
                "apiVersion": "2015-04-01",
                "name": "web",
                "type": "config",
                "dependsOn": [
                    "[resourceId('Microsoft.Web/Sites', parameters('webApi'))]"
                ],
                "properties": {
                    "cors": {
                        "allowedOrigins": ["*"]
                    },
                    "apiDefinition": {
                        "url": "[concat('https://', parameters('webApi'), '.azurewebsites.net/swagger/docs/v1')]"
                    }
                }
            }],
            "dependsOn": []
        }
    ]
}